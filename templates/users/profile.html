{%extends 'base/base.html' %}
{% load static %}

{% block 'styles' %}
<link rel="stylesheet" href="{% static 'style/style-profile.css' %}">
{% endblock %}

{%block 'content'%}

<div id="image-preview-container">
  <img src="" alt="Image Preview" class="image-preview" id="image-preview">
  <div class="btn-group">
    <button class="btn btn-outline-dark" style="color: white !important;" onclick="cancelPreview()">Cancelar</button>
    <button class="btn btn-dark" onclick="savePreview()">Salvar</button>
  </div>
</div>

<section>
  <div class="container py-5">
    <div class="row">
      <div class="col-lg-4">
        <div class="card mt-card-mobile mb-4">
          <div class="card-body text-center card-user">

            <div class="image-container position-relative d-flex justify-content-center align-items-center">
              {% include "components/user_avatar.html" with user=user size=150 class="img-fluid profile-pic" %}
            </div>

            <h5 class="my-3">{{ user.username }}</h5>
            <div class="d-flex justify-content-center mb-2">
              <a href="{% url 'users:edit_user' user.id %}" type="button" class="btn btn-outline-dark ms-1">Editar
                informações pessoais</a>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-8">
        <div class="card mb-4">
          <div class="card-body">
            <div class="row">
              <div class="col-sm-3">
                <p class="mb-0">Nome Completo</p>
              </div>
              <div class="col-sm-9">
                <p class="text-muted mb-0">{{ user.first_name|default:"--" }} {{ user.last_name|default:"--" }}</p>
              </div>
            </div>
            <hr>
            <div class="row">
              <div class="col-sm-3">
                <p class="mb-0">Email</p>
              </div>
              <div class="col-sm-9">
                <p class="text-muted mb-0">{{ user.email|default:"--" }}</p>
              </div>
            </div>
            <hr>
            <div class="row">
              <div class="col-sm-3">
                <p class="mb-0">Rede Social</p>
              </div>
              <div class="col-sm-9">
                <p class="text-muted mb-0">{{ user.personaldata.social_network|default:"--" }}</p>
              </div>
            </div>
            <hr>
            <div class="row">
              <div class="col-sm-3">
                <p class="mb-0">Data de Nascimento</p>
              </div>
              <div class="col-sm-9">
                <p class="text-muted mb-0">{{ user.personaldata.date_of_birth|date:"d/m/Y"|default:"--" }}</p>
              </div>
            </div>
            <hr>
            <div class="row">
              <div class="col-sm-3">
                <p class="mb-0">RG</p>
              </div>
              <div class="col-sm-9">
                <p class="text-muted mb-0">{{ user.personaldata.rg|default:"--" }}</p>
              </div>
            </div>
            <hr>
            <div class="row">
              <div class="col-sm-3">
                <p class="mb-0">Identificação</p>
              </div>
              <div class="col-sm-9">
                <p class="text-muted mb-0">{{ user.personaldata.bond_choice|default:"--" }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div>
      {% if enrollments %}
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="topic-color mb-0">Minhas Inscrições</h3>

        <div class="d-flex align-items-center gap-3">
          <div class="text-muted">{{ enrollments|length }} evento(s)</div>
          <div>
            <button class="btn btn-sm btn-outline-secondary me-1" type="button" data-bs-target="#enrollmentsCarousel"
              data-bs-slide="prev" aria-label="Anterior">
              <i class="bi bi-chevron-left"></i>
              Voltar
            </button>
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-target="#enrollmentsCarousel"
              data-bs-slide="next" aria-label="Próximo">
              <i class="bi bi-chevron-right"></i>
              Próximo
            </button>
          </div>
        </div>
      </div>

      <div id="enrollmentsCarousel" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner">
          {% for enrollment in enrollments %}
          {% if forloop.first or forloop.counter0|divisibleby:2 %}
          <div class="carousel-item {% if forloop.first %}active{% endif %}">
            <div class="row g-4 justify-content-left">
              {% endif %}

              <div class="col-md-6">
                <div class="card enrollment-card h-100 shadow-sm border-0 overflow-hidden"
                  style="transition: transform 0.2s, box-shadow 0.2s;">
                  <div class="position-relative" style="height: 150px; overflow: hidden;">
                    {% if enrollment.event.banner_image %}
                    <img src="{{ enrollment.event.banner_image.url }}" class="w-100 h-100 object-fit-cover"
                      alt="Banner do Evento" style="object-fit: cover;">
                    {% else %}
                    <img src="{% static 'images/images-cities/charqueadas-trevo.jpeg' %}"
                      class="w-100 h-100 object-fit-cover" alt="Imagem padrão" style="object-fit: cover;">
                    {% endif %}
                    <div class="position-absolute top-0 end-0 m-2">
                      <span class="badge bg-success" style="background-color: #273273 !important;">Inscrito</span>
                    </div>
                    <button type="button"
                      class="position-absolute top-0 start-0 m-2 btn btn-sm btn-danger d-flex align-items-center justify-content-center"
                      style="width: 32px; height: 32px; padding: 0; opacity: 0.85; border: none;"
                      data-bs-toggle="modal"
                      data-bs-target="#cancelModal{{ enrollment.id }}"
                      title="Cancelar inscrição">
                      <i class="bi bi-x-lg"></i>
                    </button>
                  </div>
                  <div class="card-body d-flex flex-column" style="flex: 1; padding: 1.25rem;">
                    <h5 class="card-title topic-color fw-bold mb-2" style="font-size: 1.1rem;">
                      {{ enrollment.event.name }}
                    </h5>
                    <div class="enrollment-info mb-2" style="flex: 1;">
                      <div class="info-item mb-2 pb-2 border-bottom">
                        <p class="text-muted mb-1"
                          style="font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                          Local de Saída
                        </p>
                        <p class="mb-0" style="font-size: 0.95rem; color: #333;">
                          {{ enrollment.route.departure_location }}
                        </p>
                      </div>
                      <div class="info-item mb-2 pb-2 border-bottom">
                        <p class="text-muted mb-1"
                          style="font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                          Início
                        </p>
                        <p class="mb-0" style="font-size: 0.95rem; color: #333;">
                          {{ enrollment.route.concentration }}
                        </p>
                      </div>
                      <div class="info-item">
                        <p class="text-muted mb-1"
                          style="font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                          Inscrição sob nome de
                        </p>
                        <p class="mb-0" style="font-size: 0.95rem; color: #333;">
                          {{ user.first_name }} {{ user.last_name }}
                        </p>
                      </div>
                    </div>
                    <div class="mt-2">
                      <a href="{% url 'events:event' pk=enrollment.event.id %}" class="btn btn-outline-primary fw-600 w-100 mb-2"
                        style="border-color: #273273; color: #273273; font-weight: 600; font-size: 0.9rem; padding: 0.6rem 1rem;">
                        <i class="bi bi-arrow-right"></i> Acompanhar Evento
                      </a>

                      <a href="{% url 'events:get_certificate' enrollment_id=enrollment.id %}"
                        class="btn btn-success fw-600 w-100"
                        style="font-weight: 600; font-size: 0.9rem; padding: 0.6rem 1rem;">
                        <i class="bi bi-download"></i> Emitir Certificado
                      </a>
                    </div>
                  </div>
                </div>
              </div>

              {% if forloop.counter|divisibleby:2 or forloop.last %}
            </div>
          </div>
          {% endif %}
          {% endfor %}
        </div>
      </div>

      {% else %}

      <div class="d-flex flex-column align-items-center text-center mt-4 py-4">

        <h4 class="fw-bold text-muted mb-2">Você ainda não participou de nenhum evento</h4>

        <p class="text-muted mb-3">
          Quando você se inscrever em um evento, ele aparecerá aqui.
        </p>

        <a href="/#events" class="btn-secondary-cric-bold btn-cric px-4 py-2">
          Ver Eventos Disponíveis
        </a>

      </div>

      {% endif %}
    </div>
  </div>
</section>

<!-- Modal de confirmação de cancelamento -->
{% for enrollment in enrollments %}
<div class="modal fade" id="cancelModal{{ enrollment.id }}" tabindex="-1" aria-labelledby="cancelModalLabel{{ enrollment.id }}" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-bold" id="cancelModalLabel{{ enrollment.id }}">
          <i class="bi bi-exclamation-triangle-fill text-warning"></i> Confirmar Cancelamento
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">Tem certeza que deseja cancelar sua inscrição no evento <strong>{{ enrollment.event.name }}</strong>?</p>
        <div class="alert alert-warning d-flex align-items-start" role="alert">
          <i class="bi bi-info-circle-fill me-2 mt-1"></i>
          <div>
            <strong>Atenção:</strong> Sua inscrição será cancelada permanentemente. Caso mude de ideia, será necessário realizar uma nova inscrição no evento.
          </div>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-arrow-left"></i> Voltar
        </button>
        <a href="{% url 'events:delete_enrollment' enrollment_id=enrollment.id %}" class="btn btn-danger">
          <i class="bi bi-trash"></i> Sim, cancelar inscrição
        </a>
      </div>
    </div>
  </div>
</div>
{% endfor %}

<script src="{% static 'js/users/profile.js' %}" async></script>

{%endblock%}